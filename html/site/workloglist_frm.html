<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui-pull-refresh.css" />
    <style type="text/css">
    .am-with-fixed-tab {
      padding-top: 2rem;
    }
    </style>
</head>
<body class="am-with-fixed-tab">
  <div id="header" class="am-header-fixed">
    <div class="aui-tab " id="tab" >
        <div class="aui-tab-item aui-active"><div id="badge_0" class="aui-badge" style="left:70%;display:none;" ></div>我收到的</div>
        <div class="aui-tab-item">我提交的</div>
    </div>
  </div>


    <section class="aui-refresh-content">
      <ul id="workLogContent" name="workLogTabContent" class="aui-list aui-media-list" style="background-color:#f5f5f5">
<br/>  <br/><br/><br/><br/><br/><br/>  <br/><br/><br/><br/><br/>
      </ul>

        <ul id="myWorkLogContent" name="workLogTabContent" class="aui-list aui-media-list" style="background-color:#f5f5f5;display:none">
<br/>  <br/><br/><br/><br/><br/><br/>  <br/><br/><br/><br/><br/>
        </ul>

      </section>


    <script id="workLogTpl" type="text/html">

        {{each list}}

        <li class="aui-list-item aui-list-item-middle" style="background-color:#ffffff;" onclick="viewWorkLog('{{$value[0]}}')">
            <div id="dot_{{$value[0]}}" class="aui-left-1 aui-dot aui-pull-left " style="display:none"></div>
            <div class="aui-row aui-list-item-text aui-font-size-12 aui-padded-t-5 aui-padded-b-10 aui-padded-r-15" >
              <div class="aui-col-xs-6 aui-text-left"> {{$value[1]}}&nbsp;{{$value[2]}}</div>
              <div class="aui-col-xs-6 aui-text-right">{{$value[3]}}</div>
            </div>
            <div class="aui-media-list-item-inner">
                <div class="aui-list-item-inner">
                  <div class="aui-list-item-text" style="display:inline-flex;">
                      <span class="aui-ellipsis" style="width:16em;">{{$value[4]}}</span>
                  </div>
                </div>
            </div>

        </li>

        {{/each}}
    </script>

    <script id="myWorkLogTpl" type="text/html">

        {{each list}}

        <li class="aui-list-item aui-list-item-middle" style="background-color:#ffffff;" onclick="editWorkLog('{{$value[0]}}')">
            <div id="dot_{{$value[0]}}" class="aui-left-1 aui-dot aui-pull-left " style="display:none"></div>
            <div class="aui-row aui-list-item-text aui-font-size-12 aui-padded-t-5 aui-padded-b-10 aui-padded-r-15" >
              <div class="aui-col-xs-6 aui-text-left"> {{$value[1]}}&nbsp;{{$value[2]}}</div>
              <div class="aui-col-xs-6 aui-text-right">{{$value[3]}}</div>
            </div>
            <div class="aui-media-list-item-inner">
                <div class="aui-list-item-inner">
                  <div class="aui-list-item-text" style="display:inline-flex;">
                      <span class="aui-ellipsis" style="width:16em;">{{$value[4]}}</span>
                  </div>
                </div>
            </div>

        </li>

        {{/each}}
    </script>

    <!-- {{if $value[6] ==0}}{{/if}} -->
</body>
<script type="text/javascript" src="../../script/api.js" ></script>
<script type="text/javascript" src="../../css/amazeui/js/jquery.min.js"></script>
<script type='text/javascript' src='../../script/common.js'></script>
<script type='text/javascript' src='../../script/queryapi.js'></script>
<script type='text/javascript' src='../../script/template.js'></script>
<script type="text/javascript" src="../../script/aui-pull-refresh.js"></script>
<script type="text/javascript" src="../../script/aui-scroll.js" ></script>
<script type='text/javascript' src='../../script/controls.js'></script>
<script type="text/javascript" src="../../script/aui-tab.js"></script>
<script type="text/javascript">

var tab;
var tabIndex = 1;
var tab2loaded = false;
var pageComp = new PageComponent(0,10,loadWorkLogs);
var pageCompMy = new PageComponent(0,10,loadMyWorkLogs);

apiready = function () {

  var height = $("#header").height();
  $('body').css('padding-top', height+1);

  createTab();

  initPull();
  initPullBottom();
  loadWorkLogData();

  api.addEventListener({
  name:'viewappear'
  },function(ret,err){
    loadKindRedPoint();
  });
}

function loadKindRedPoint(){
  $(".aui-badge").css("display","none");
  AjaxApi.getkindredpoint("SiteWorkLog");
}


//create callback
function loadData(){
  tab.setActive(2);
  tab2loaded = false;
  switchTab(2);
}

function initPull(){
  var pullRefresh = new auiPullToRefresh({
    container: document.querySelector('.aui-refresh-content'),
    triggerDistance: 100
},function(ret){
    if(ret.status=="success"){
      loadWorkLogData();
      setTimeout(function(){
        pullRefresh.cancelLoading(); //刷新成功后调用此方法隐藏
      },1500);
    }
})
}

function initPullBottom(){
  var scroll = new auiScroll({
          listen:true,
          distance:5 //判断到达底部的距离，isToBottom为true
      },function(ret){
          if(ret.isToBottom){
            loadMoreWorkLogData();
            //alert("已到达底部");
              //document.getElementById("demo").textContent = "已到达底部";
          }else{
              //document.getElementById("demo").textContent = "滚动高度："+ret.scrollTop;

          }

      });

}


function createTab(){
  tab = new auiTab({
   element:document.getElementById("tab"),
},function(ret){
  switchTab(ret["index"]);
});
}

function switchTab(idx){
  tabIndex = idx;
  if(tabIndex == 1){
    hideTabContents();
  $("#workLogContent").css("display","block");
  }else if(tabIndex==2){
    if(!tab2loaded) pageCompMy.load();
    tab2loaded=true;
    hideTabContents();
    $("#myWorkLogContent").css("display","block");
  }
}

function hideTabContents(){
  $("*[name='workLogTabContent']").each(function(){
    $(this).css("display","none");
  });
}

function loadWorkLogData(){
  if(tabIndex==1){
    pageComp.load();
  }else if(tabIndex==2){
    pageCompMy.load();
  }
}

function loadMoreWorkLogData(){
  if(tabIndex==1){
    pageComp.loadMore();
  }else if(tabIndex==2){
    pageCompMy.loadMore();
  }
}


function preWeekDay(datalist)
{
  var picIndex = 2;
    for (var i = 0; i < datalist.length; i++) {
      var item = datalist[i];
      if(item[picIndex] && item[picIndex]!=""){
        item[picIndex] = gGetWeekDay(item[picIndex]);
      }
    }
}

function loadWorkLogs(pagecomp){
    pagecomp.setLoadState(true);
    var param = $.extend(pagecomp.getPageParam(),TServerInfo.getProjUserParam());
    AjaxApi.query("query_1211",param,function(data){
      if(data.total) pagecomp.setTotal(data.total);

      var datalist = data.list;
      if(datalist){
        preWeekDay(datalist);
        var tplData = {
          "list" : datalist
        };
        var html = template("workLogTpl", tplData);

        if(pagecomp.getIsAppend()){
          $("#workLogContent").append(html);
        }else{
          $("#workLogContent").html(html);
        }
      }
      pagecomp.setLoadState(false);

      AjaxApi.getredpoint("SiteWorkLog",0);
    });
}

function loadMyWorkLogs(pagecomp){
    pagecomp.setLoadState(true);
    var param = $.extend(pagecomp.getPageParam(),TServerInfo.getProjUserParam());
    AjaxApi.query("query_1212",param,function(data){
      if(data.total) pagecomp.setTotal(data.total);

      var datalist = data.list;
      if(datalist){
        preWeekDay(datalist);
        var tplData = {
          "list" : datalist
        };
        var html = template("myWorkLogTpl", tplData);

        if(pagecomp.getIsAppend()){
          $("#myWorkLogContent").append(html);
        }else{
          $("#myWorkLogContent").html(html);
        }
      }
      pagecomp.setLoadState(false);
    });
}

function editWorkLog(id){

  api.openWin({
                name: "worklogcurd_win",
                url: "worklogcurd_win.html",
                pageParam: {
                    isFrame: false,
                    workLogId:id
                },
                bgColor: '#FFFFFF',
                slidBackEnabled: false,
                vScrollBarEnabled:false,
                hScrollBarEnabled:false,
                delay: 0
            }
    );
}

function viewWorkLog(id){

  api.openWin({
                name: "worklogview_win",
                url: "worklogview_win.html",
                pageParam: {
                    isFrame: false,
                    workLogId:id
                },
                bgColor: '#FFFFFF',
                slidBackEnabled: false,
                vScrollBarEnabled:false,
                hScrollBarEnabled:false,
                delay: 0
            }
    );

  AjaxApi.removeredpoint(id,"SiteWorkLog");
}

</script>
</html>
