<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui-pull-refresh.css" />
    <style type="text/css">
    .am-with-fixed-tab {
      padding-top: 2rem;
    }
    </style>
</head>
<body class="am-with-fixed-tab">
  <div id="header" class="am-header-fixed">
    <div class="aui-tab " id="tab" >
        <div class="aui-tab-item aui-active"><div id="badge_0" class="aui-badge" style="left:70%;display:none;" ></div>我收到的</div>
        <div class="aui-tab-item ">我发布的</div>
        <div class="aui-tab-item"><div id="badge_1" class="aui-badge" style="left:70%;display:none;" ></div>我关注的</div>
    </div>
  </div>

    <section class="aui-refresh-content">
        <ul id="tellTechContent" name="tellTechTabContent" class="aui-list aui-media-list" style="background-color:#f5f5f5">
<br/>  <br/><br/><br/><br/><br/><br/>  <br/><br/><br/><br/><br/>
        </ul>

        <ul id="myDynamicContent" name="tellTechTabContent" class="aui-list aui-media-list" style="background-color:#f5f5f5;display:none">
<br/>  <br/><br/><br/><br/><br/><br/>  <br/><br/><br/><br/><br/>
        </ul>

        <ul id="shareDynamicContent" name="tellTechTabContent" class="aui-list aui-media-list" style="background-color:#f5f5f5;display:none">
<br/>  <br/><br/><br/><br/><br/><br/>  <br/><br/><br/><br/><br/>
        </ul>

      </section>


    <script id="tellTechTpl" type="text/html">

        {{each list}}

        <li class="aui-list-item aui-list-item-middle" style="background-color:#ffffff;" onclick="viewDynamic('{{$value[0]}}')">
            <div id="dot_{{$value[0]}}" class="aui-left-1 aui-dot aui-pull-left " style="display:none"></div>
            <div class="aui-media-list-item-inner">
                <div class="aui-list-item-inner">
                  <div class="aui-list-item-text" style="display:inline-flex;">
                      <span class="aui-ellipsis" style="width:16em;">{{$value[1]}}</span>
                  </div>
                </div>
            </div>
            <div class="aui-row aui-list-item-text aui-font-size-12 aui-padded-t-5 aui-padded-b-10 aui-padded-r-15" >
              <div class="aui-col-xs-6 aui-text-left"> 发布人:{{$value[2]}}</div>
              <div class="aui-col-xs-6 aui-text-right">创建时间:{{$value[3]}}</div>
            </div>
        </li>

        {{/each}}
    </script>

    <!-- {{if $value[6] ==0}}{{/if}} -->
</body>
<script type="text/javascript" src="../../script/api.js" ></script>
<script type="text/javascript" src="../../css/amazeui/js/jquery.min.js"></script>
<script type='text/javascript' src='../../script/common.js'></script>
<script type='text/javascript' src='../../script/queryapi.js'></script>
<script type='text/javascript' src='../../script/template.js'></script>
<script type="text/javascript" src="../../script/aui-pull-refresh.js"></script>
<script type="text/javascript" src="../../script/aui-scroll.js" ></script>
<script type='text/javascript' src='../../script/controls.js'></script>
<script type="text/javascript" src="../../script/aui-tab.js"></script>
<script type="text/javascript">

var tab;
var tabIndex = 1;
var tab2loaded = false;
var tab3loaded = false;

var pageComp = new PageComponent(0,10,loadDynamics);
var pageCompMy = new PageComponent(0,10,loadMyDynamics);
var pageCompShare = new PageComponent(0,10,loadShareDynamics);

apiready = function () {

  var height = $("#header").height();
  $('body').css('padding-top', height+1);

createTab();
  initPull();
  initPullBottom();
  pageComp.load();

  api.addEventListener({
  name:'viewappear'
  },function(ret,err){
    loadKindRedPoint();
  });
}

function loadKindRedPoint(){
  $(".aui-badge").css("display","none");
  AjaxApi.getkindredpoint("SiteDynamic");
}

//create callback
function loadData(){
  tab.setActive(2);
  tab2loaded = false;
  switchTab(2);
}

function initPull(){
  var pullRefresh = new auiPullToRefresh({
    container: document.querySelector('.aui-refresh-content'),
    triggerDistance: 100
},function(ret){
    if(ret.status=="success"){
      loadDynamicData();
      setTimeout(function(){
        pullRefresh.cancelLoading(); //刷新成功后调用此方法隐藏
      },1500);
    }
})
}

function createTab(){
  tab = new auiTab({
   element:document.getElementById("tab"),
},function(ret){
  switchTab(ret["index"]);
});
}

function switchTab(idx){
  tabIndex = idx;
  if(tabIndex == 1){
    hideTabContents();
  $("#tellTechContent").css("display","block");
  }else if(tabIndex==2){
    if(!tab2loaded) pageCompMy.load();
    tab2loaded=true;
    hideTabContents();
    $("#myDynamicContent").css("display","block");
  }else if(tabIndex==3){
    if(!tab3loaded) pageCompShare.load();
    tab3loaded=true;
    hideTabContents();
    $("#shareDynamicContent").css("display","block");
  }
}

function hideTabContents(){
  $("*[name='tellTechTabContent']").each(function(){
    $(this).css("display","none");
  });
}

function loadDynamicData(){
  if(tabIndex==1){
    pageComp.load();
  }else if(tabIndex==2){
    pageCompMy.load();
  }else if(tabIndex==3){
    pageCompShare.load();
  }
}

function loadMoreDynamickData(){
  if(tabIndex==1){
    pageComp.loadMore();
  }else if(tabIndex==2){
    pageCompMy.loadMore();
  }else if(tabIndex==3){
    pageCompShare.loadMore();
  }
}

function initPullBottom(){
  var scroll = new auiScroll({
          listen:true,
          distance:5 //判断到达底部的距离，isToBottom为true
      },function(ret){
          if(ret.isToBottom){
            loadMoreDynamickData();
            //alert("已到达底部");
              //document.getElementById("demo").textContent = "已到达底部";
          }else{
              //document.getElementById("demo").textContent = "滚动高度："+ret.scrollTop;

          }

      });

}

function loadDynamics(pagecomp){
    pagecomp.setLoadState(true);
    var param = $.extend(pagecomp.getPageParam(),TServerInfo.getProjUserParam());
    AjaxApi.query("query_1221",param,function(data){
      if(data.total) pagecomp.setTotal(data.total);

      var datalist = data.list;
      if(datalist){
        var tplData = {
          "list" : datalist
        };
        var html = template("tellTechTpl", tplData);

        if(pagecomp.getIsAppend()){
          $("#tellTechContent").append(html);
        }else{
          $("#tellTechContent").html(html);
        }
      }
      pagecomp.setLoadState(false);

      AjaxApi.getredpoint("SiteDynamic",0);
    });
}

function loadMyDynamics(pagecomp){
  pagecomp.setLoadState(true);
  var param = $.extend(pagecomp.getPageParam(),TServerInfo.getProjUserParam());
  AjaxApi.query("query_1222",param,function(data){
    if(data.total) pagecomp.setTotal(data.total);

    var datalist = data.list;
    if(datalist){
      var tplData = {
        "list" : datalist
      };
      var html = template("tellTechTpl", tplData);

      if(pagecomp.getIsAppend()){
        $("#myDynamicContent").append(html);
      }else{
        $("#myDynamicContent").html(html);
      }
    }
    pagecomp.setLoadState(false);
  });
}

function loadShareDynamics(pagecomp){
  pagecomp.setLoadState(true);
  var param = $.extend(pagecomp.getPageParam(),TServerInfo.getProjUserParam());
  AjaxApi.query("query_1223",param,function(data){
    if(data.total) pagecomp.setTotal(data.total);

    var datalist = data.list;
    if(datalist){
      var tplData = {
        "list" : datalist
      };
      var html = template("tellTechTpl", tplData);

      if(pagecomp.getIsAppend()){
        $("#shareDynamicContent").append(html);
      }else{
        $("#shareDynamicContent").html(html);
      }
    }
    pagecomp.setLoadState(false);

    AjaxApi.getredpoint("SiteDynamic",1);
  });
}

function viewDynamic(id){

  api.openWin({
                name: "dynamicview_win",
                url: "dynamicview_win.html",
                pageParam: {
                    isFrame: false,
                    dynamicId:id
                },
                bgColor: '#FFFFFF',
                slidBackEnabled: false,
                vScrollBarEnabled:false,
                hScrollBarEnabled:false,
                delay: 0
            }
    );

  AjaxApi.removeredpoint(id,"SiteDynamic");
}

</script>
</html>
