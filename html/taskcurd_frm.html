<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <style type="text/css">
    .aui-list .aui-list-item-media {
        width: 3rem;
    }
    .notes-add {
        position: fixed;
        left: 0.5rem;
        bottom: 0.5rem;
        width: 3rem;
        z-index: 99;
    }
    textarea {
        height: 8rem;
        background-color: #ffffff;
        padding: 0.5rem;
    }
    .photos img {
        display: block;
        width: 100%;
    }
    .add-photos > div {
        width: 100%;
        height:5.15rem;
        line-height: 5.15rem;
    }
    .add-photos > div .aui-iconfont {
        font-size: 2rem;
        color: #ccc;
    }
    .image-item {
        position: relative;
        height: 5.3rem;
        overflow: hidden;
        background-color: #f0f0f0;
    }
    .image-item img {
        display: block;
        margin: 0 auto;
        width: auto;
        height: 100%;
    }
    .image-item .delete-btn {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 28px;
        height: 28px;
        background-color: rgba(0,0,0,0.7);
        margin-left: -14px;
        margin-top: -14px;
        color: #ffffff;
        text-align: center;
        border-radius: 50%;
    }
    </style>
</head>
<body>

  <div class="aui-bar aui-bar-btn aui-margin-t-15" style="width:80%;">
    <div name="PriorityEl" class="aui-bar-btn-item aui-active" onclick="switchPriority(0,this)">普通</div>
    <div name="PriorityEl" class="aui-bar-btn-item" onclick="switchPriority(1,this)">重要</div>
    <div name="PriorityEl" class="aui-bar-btn-item" onclick="switchPriority(2,this)">紧急</div>
</div>

  <section class="aui-content-padded">
  <ul class="aui-list aui-form-list">
    <li class="aui-list-item">
        <div class="aui-list-item-inner">

            <div class="aui-list-item-input">
                <input id="Title" type="text" placeholder="任务内容(30字以内)">
            </div>
        </div>
    </li>
  </ul>
  </section>
  <section class="aui-content-padded">
    <textarea id="Content" style="height:8em;overflow-y:scroll;background-color:#ffffff;" placeholder="任务描述(500字内)"></textarea>
  </section>
  <p class="aui-margin-l-15 aui-margin-t-15">附件图片(长按可删除图片) </p>
  <section class="aui-content-padded">
    <div id="imageLists"  class="aui-row aui-row-padded">
        <div id="txtImage" class="aui-col-xs-4 add-photos" onclick="ImageApi.fastSelectImage({},'txtImage',true);">
            <div class="aui-border aui-text-center">
                <i class="aui-iconfont aui-icon-plus"></i>
            </div>
        </div>
    </div>
  </section>
  <section class="aui-content-padded">
  <ul class="aui-list aui-form-list">
  <li class="aui-list-item">
      <div class="aui-list-item-inner">
          <div class="aui-list-item-label">
              执行人
          </div>

          <div class="aui-list-item-input">
                <input  id="ExecUserNames" placeholder="" type="text" readonly>
          </div>
          <div class="aui-pull-right  " style="width:40px !important">
              <a onclick="selectUsers('ExecUserNames')"  style="width:100%"> &gt;&gt;&nbsp;</a>
          </div>
      </div>
  </li>
  <li class="aui-list-item">
      <div class="aui-list-item-inner">
          <div class="aui-list-item-label">
              督办人
          </div>
          <div class="aui-list-item-input">
                <input id="SuperUserNames" placeholder="" type="text" readonly>
          </div>
          <div class="aui-pull-right  " style="width:40px !important">
              <a onclick="selectUsers('SuperUserNames')"  style="width:100%"> &gt;&gt;&nbsp;</a>
          </div>
      </div>
  </li>
  <li class="aui-list-item">
      <div class="aui-list-item-inner">
          <div class="aui-list-item-label">
              截止日期
          </div>
          <div class="aui-list-item-input">
                <input id="ExpireDate" placeholder="" type="text" readonly>
          </div>
          <div class="aui-pull-right  " style="width:40px !important">
              <a onclick="datepick()"  style="width:100%"> &gt;&gt;&nbsp;</a>
          </div>

      </div>
  </li>
  </ul>
  </section>

</body>

<script type='text/javascript' src='../script/api.js'></script>
<script type="text/javascript" src="../css/amazeui/js/jquery.min.js"></script>
<script type='text/javascript' src='../script/common.js'></script>
<script type='text/javascript' src='../script/queryapi.js'></script>
<script type='text/javascript' src='../script/template.js'></script>
<script type="text/javascript" src="../script/hammer.min.js"></script>
<script type="text/javascript" src="../script/imageapi.js"></script>
<script type="text/javascript" src="../script/aui-toast.js" ></script>
<script type="text/javascript" src="../script/bluebird.min.js" ></script>

<script type='text/javascript'>
var toast = new auiToast();

var priority=0;

apiready = function(){

}

function switchPriority(pr,el){
  priority = pr;
  unActivePriorityEl();
  $(el).addClass("aui-active");
}

function unActivePriorityEl(){
  $("*[name='PriorityEl']").each(function(){
    $(this).removeClass("aui-active");
  });
}

function datepick(){
  api.openPicker({
      type: 'date',
      date: new Date().Format("yyyy-MM-dd"),
      title: '选择时间'
  }, function(ret, err) {
      if (ret) {
        var monthstr = ret.month+"";
        var daystr = ret.day+"";
          $("#ExpireDate").val(ret.year+"-"+monthstr.PadLeft(2,0)+"-"+daystr.PadLeft(2,0));
      }
  });
}

function showMsg(msg){
  api.toast({
      msg : msg,
      duration : 1000,
      location : 'bottom'
    });
}

function enableClickOnceBtn(){
  try{
  api.execScript({
    name: 'taskcurd_win',
    script: 'enableClickOnceBtn()'
   });
  }catch(e){}
}

function commit()
{

  if($("#Title").val() == ""){
    showMsg("任务内容必填!");
    enableClickOnceBtn();
    return ;
  }

  if($("#Content").val() == ""){
    showMsg("任务描述必填!");
    enableClickOnceBtn();
    return ;
  }

  var users = $("#ExecUserNames").attr("users");
  if(users){
    var usersArray = JSON.parse(users);
    if(usersArray.length==0){
        showMsg("执行人必填!");
        enableClickOnceBtn();
      return ;
    }
  }else{
      showMsg("执行人必填!");
      enableClickOnceBtn();
    return ;
  }

   users = $("#SuperUserNames").attr("users");
  if(users){
    var usersArray = JSON.parse(users);
    if(usersArray.length==0){
      showMsg("监督人必填!");
      enableClickOnceBtn();
      return ;
    }
  }else{
    showMsg("监督人必填!");
    enableClickOnceBtn();
    return ;
  }

  if($("#ExpireDate").val() == ""){
    showMsg("截止日期必填!");
    enableClickOnceBtn();
    return ;
  }

  toast.loading({
        title:"正在保存...",
        duration:2000
    },function(ret){

    });

    saveTask();
}

var masterEntityOp = new EntityBatchOp("OaTask","Title,Content,Priority,ExpireDate");
var userLinkEntityOp = new EntityBatchOp("OaTaskLink","","UserId");
var attachmentEntityOp = CreateAttachEntBatchOp();

function saveTask(){
  var ownerId = GetUuid();
  var entObj = {"Id":ownerId,
        "Title":$("#Title").val(),
        "Content":$("#Content").val(),
        "ProjectId":TServerInfo.getProjectId(),
        "CreateUserId":TServerInfo.getUserId(),
        "Priority":priority,
        "ExpireDate":$("#ExpireDate").val()+gDayLtTimeSuffix
      };
  masterEntityOp.addEntity(entObj);

  //images
  var imageInfos = [];
  $("#imageLists").find("img").each(function(){
    var imageInfo = ImageApi.getImageInfo($(this).attr("id"),$(this).attr("src"),"");
    imageInfo["OwnerId"] = ownerId;
    imageInfos.push(imageInfo);
  });

  //links
  var userLinks = [];
  var users = $("#ExecUserNames").attr("users");
  if(users){
    var usersArray = JSON.parse(users);
    if(usersArray.length>0){
      for(var i=0;i<usersArray.length;++i){
          userLinks.push({"Id":GetUuid(),"TaskId":ownerId,"Kind":0,"UserId":usersArray[i][0],"ProjectId":TServerInfo.getProjectId()});
      }
    }
  }

   users = $("#SuperUserNames").attr("users");
  if(users){
      usersArray = JSON.parse(users);
      if(usersArray.length>0){
        for(var i=0;i<usersArray.length;++i){
            userLinks.push({"Id":GetUuid(),"TaskId":ownerId,"Kind":1,"UserId":usersArray[i][0],"ProjectId":TServerInfo.getProjectId()});
        }
      }
  }

  userLinkEntityOp.addEntities(userLinks);

  AjaxApi.batchSave([masterEntityOp,userLinkEntityOp],imageInfos,
    {"noTips":true},function(data){
       saveSuccess();
  });
}

function reloadParent(){
  try{
  api.execScript({
    name: 'tasklist_win',
    frameName: 'tasklist_frm',
    script: 'loadData()'
   });
  }catch(e){}
}

function saveSuccess(){
  api.toast({
      msg : "提交成功!",
      duration : 1000,
      location : 'bottom'
    });

setTimeout(function(){reloadParent();api.closeWin();},1000);
}

var currSelectUserNodeId;
function selectUsers(nodeid){
   currSelectUserNodeId = nodeid;
   var users = $("#"+nodeid).attr("users");
   var tags = $("#"+nodeid).attr("tags");

   api.openWin({
                name: "app_selectusers",
                url: "../selectusers.html",
                pageParam: {
                    isFrame: false,
                    srcWinName:"taskcurd_win",
                    srcFrameName:"taskcurd_frm",
                    selectedUsers: (users?users:"[]"),
                    tags:(tags?tags:"[]")
                },
                bgColor: '#FFFFFF',
                slidBackEnabled: false,
                vScrollBarEnabled:false,
                hScrollBarEnabled:false,
                delay: 0
            }
    );
}

function setSelectUsers(data,tagstr){
    $("#"+currSelectUserNodeId).attr("users",data);
    $("#"+currSelectUserNodeId).attr("tags",tagstr);

    var selectedUsers = JSON.parse(data);

    var selectUserStr = "";
    for(var i=0;i<selectedUsers.length;++i){
      selectUserStr+=selectedUsers[i][1]+",";
    }

    $("#"+currSelectUserNodeId).val(selectUserStr);
}

</script>
</html>
