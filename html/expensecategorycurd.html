<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <title></title>
      <link rel="stylesheet" type="text/css" href="../css/app.css" />
      <link rel="stylesheet" type="text/css" href="../css/aui.css" />
      <link rel="stylesheet" type="text/css" href="../css/aui-pull-refresh.css" />
      <link rel="stylesheet" type="text/css" href="../css/font-awesome/css/font-awesome.min.css" />
      <style>
          body{

          }

          .am-with-fixed--custheader {
            padding-top: 2.25rem;
          }
      </style>
  </head>
  <body class="am-with-fixed--custheader aui-margin-l-0">
    <div id="header" class="am-header-fixed" >
    <header id="aui-header" class="aui-bar aui-bar-nav aui-bar-light">
      <a class="aui-btn aui-pull-left" tapmode onclick="closeWin()">
          <span class="aui-iconfont aui-icon-left"></span>
      </a>
    <div class="aui-title" id="title">报销分类</div>

    <a name="__clickOnceBtn" class="aui-btn aui-pull-right" tapmode onclick="commit()">
        <span class="aui-iconfont aui-icon-correct"></span>
    </a>
    </header>
</div>

<section >
<ul class="aui-list aui-form-list" id="expenseCategoryContent" style="background-color:#f5f5f5">

</ul>
</section>
<br/>
<div class="aui-text-center  aui-margin-15" >
<div class="aui-btn aui-btn-block aui-btn-primary" onclick="addExpenseCategory()">新增分类</div>
</div>

      <script id="expenseCategoryTpl" type="text/html">
          {{each list}}
          <li class="aui-list-item" id="li_{{$value[0]}}" style="height:40px" style="background-color:#ffffff !important;">
              <div class="aui-list-item-inner">
                  <div class="aui-list-item-label" id="orderNo_{{$value[0]}}">
                      {{$value[1]}}
                  </div>

                  <div class="aui-list-item-input" >
                        <input  id="{{$value[0]}}_Name"  placeholder="" type="text"  value="{{$value[2]}}">
                  </div>

                  <div class="aui-pull-right  " style="width:40px !important">
                    <a onclick="removeNode('{{$value[0]}}')"  style="width:100%"> <i class="fa fa-close"></i> </a>
                  </div>


              </div>
          </li>
          {{/each}}
      </script>
  </body>
  <script type="text/javascript" src="../script/api.js" ></script>
  <script type="text/javascript" src="../css/amazeui/js/jquery.min.js"></script>
  <script type='text/javascript' src='../script/common.js'></script>
  <script type='text/javascript' src='../script/queryapi.js'></script>
  <script type='text/javascript' src='../script/template.js'></script>
  <script type="text/javascript" src="../script/imageapi.js"></script>
  <script type="text/javascript" src="../script/aui-dialog.js" ></script>
  <script type="text/javascript" src="../script/aui-toast.js" ></script>
  <script type="text/javascript">
  function closeWin(){
      api.closeWin({
      });
  }

var toast = new auiToast();
var datalist=[];
var deleteIds=[];
var origCategoryIds=[];

      apiready = function(){
        var header = $api.byId('aui-header');
        $api.fixStatusBar(header);

        var height = $("#header").height();
        $('body').css('padding-top', height);

          initData();
      };

      function initData(){
          if(api.pageParam.projectId){
              loadExpenseCategorys(api.pageParam.projectId);
          }
      }

      function preIntProc(datalist){
        for(var j=0;j<datalist.length;++j){
            var item = datalist[j];
            if(item.length >=2){
               item[1] = parseInt(item[1]);
            }
        }
      }

      function loadExpenseCategorys(projectId){
        AjaxApi.query("query_1019",{"ProjectId":projectId},function(data){

          if(data.list){
            datalist = data.list;
            origCategoryIds = datalist.select(0);
            preIntProc(datalist);
            var tplData = {
              "list" : datalist
            };
            var html = template("expenseCategoryTpl", tplData);
            $("#expenseCategoryContent").html(html);

          }
        });
      }

      function addExpenseCategory(){
        var emptyItem = [GetUuid(),datalist.length+1,""];
        var tplData = {
          "list" : [emptyItem]
        };
        var html = template("expenseCategoryTpl", tplData);
        $("#expenseCategoryContent").append(html);

        datalist.push(emptyItem);
      }

      function removeNode(id){
        $("#li_"+id).remove();
        for(var i=datalist.length-1;i>=0;--i){
          var item = datalist[i];
          if(item[0] == id){
              datalist.splice(i,1);
              deleteIds.push(id);

              if(i<datalist.length){
                for(var j=i;j<datalist.length;++j){
                    var nextitem = datalist[j];
                    nextitem[1]=j+1;
                    $("#orderNo_"+nextitem[0]).html(j+1);
                }
              }
              break;
          }
        }
      }

      function enableClickOnceBtn(){
        $("*[name='__clickOnceBtn']").removeClass("__btnClickOnce");
      }

      function commit(){
        if($("*[name='__clickOnceBtn']").hasClass('__btnClickOnce')) {
            return;
        }
        $("*[name='__clickOnceBtn']").addClass("__btnClickOnce");

          for(var j=0;j<datalist.length;++j){
              var item = datalist[j];
              var id=item[0];
              var orderNo = item[1];
              var name = $("#"+id+"_Name").val();

              if(!name || name==""){
                api.toast({
                  msg : '第'+orderNo+"行名称不能为空",
                  duration : 2000,
                  location : 'bottom'
                });
                enableClickOnceBtn();
                return ;
              }
          }

          toast.loading({
                title:"正在保存...",
                duration:2000
            },function(ret){

            });


            if(api.pageParam.projectId && api.pageParam.projectId!=""){
              saveExpenseCategory();
            }
      }

      function saveSuccess(){
        api.toast({
            msg : "提交成功!",
            duration : 1000,
            location : 'bottom'
          });

      setTimeout(function(){api.closeWin();},1000);
      }

      var detailsEntityOp = new EntityBatchOp("OaExpenseCategory","OrderNo,Name");

      function saveExpenseCategory(){
          var expenseCategorys = [];
          for(var j=0;j<datalist.length;++j){
              var item = datalist[j];
              var id=item[0];
              var orderNo = item[1];
              var name = $("#"+id+"_Name").val();

              var expenseCategory = {"Id":id,"OrderNo":orderNo,"ProjectId":api.pageParam.projectId,
              "Name":name};
              expenseCategorys.push(expenseCategory);
          }

          var nowIds = expenseCategorys.select("Id");
          var addDetails = expenseCategorys.subtractBy("Id",origCategoryIds);
          var updateDetails = expenseCategorys.subtractBy("Id",addDetails.select("Id"));
          var deleteDetails = origCategoryIds.subtract(nowIds);

          detailsEntityOp.addEntities(addDetails);
          detailsEntityOp.updateEntities(updateDetails);
          detailsEntityOp.deleteByIds(deleteDetails);

          AjaxApi.batchSave([detailsEntityOp],[],
            {"noTips":true},function(data){
               saveSuccess();
          });

          // if(expenseCategorys.length>0){
          //   AjaxApi.rest("saveEntities","OaExpenseCategory",expenseCategorys,function(data){
          //       resolve();
          //   },{"noTips":true});
          // }else{
          //   resolve();
          // }
       }

      //  function deleteExpenseCategorys(){
      //    return new Promise(function(resolve, reject) {
      //       if(deleteIds.length>0){
      //         AjaxApi.rest("deleteEntities","OaExpenseCategory",deleteIds,function(data){
      //           resolve();
       //
      //         },{"noTips":true});
      //       }else{
      //         resolve();
      //       }
      //    });
      //  }

  </script>
  </html>
