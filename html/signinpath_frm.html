<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <link rel="stylesheet" type="text/css" href="../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/font-awesome/css/font-awesome.min.css" />

    <style type="text/css">
    .am-option-circle{
    	border-radius: 50%;
    	width:4em;
    	height: 4em;
    	padding-top: .25em;
    }

    .am-option-secondary {
        border-color: #3bb4f2;
        border: 1px solid ;
        color:#3bb4f2;
    }

    .am-with-fixed-tab {
      padding-top: 8em;
    }
    </style>
</head>
<body class="am-with-fixed-tab">
  <div id="header" class="am-header-fixed" style="background-color:#F5F5F5;">
    <div style="height:80px;">
    <div  style="padding-top:15px" >
      <div class="aui-pull-left aui-margin-l-15 aui-margin-t-5">
          <div id="dayinfo" class="aui-font-size-20"></div>
          <div id="dateinfo"></div>
      </div>
      <div class="aui-pull-right aui-margin-r-15 aui-text-center" onclick="signIn()">
          <div><i class="aui-iconfont aui-icon-location aui-font-size-20"></i></div>
          <span class=" aui-font-size-12">上报位置</span>
      </div>
    </div>
    </div>
    <div class="aui-bar aui-bar-btn aui-bar-btn-full" >
            <div class="aui-bar-btn-item " style="border-color:#cccccc !important">出勤<br/><span id="normalCnt" class="aui-text-primary aui-font-size-18">0</span>天</div>
            <div class="aui-bar-btn-item" style="border-color:#cccccc !important">迟到<br/><span id="lateCnt" class="aui-text-primary aui-font-size-18">0</span>天</div>
            <div class="aui-bar-btn-item" style="border-color:#cccccc !important">早退<br/><span id="outCnt" class="aui-text-primary aui-font-size-18">0</span>天</div>
            <div class="aui-bar-btn-item" style="border-color:#cccccc !important">缺卡<br/><span id="noSignCnt" class="aui-text-primary aui-font-size-18">0</span>天</div>
        </div>
      <div class="aui-bar aui-bar-btn" style="width:80%;">
            <div class="aui-bar-btn-item" style="border-left:1px solid #cccccc;border-color:#cccccc !important">
                  <span id="SignInStartTime"></span> -- <span id="SignInEndTime"></span>
            </div>
        </div>
    </div>
      <br/>
    <div id="signInLocationContent" class="aui-timeline">

        </div>



        <div id="spanFoot" style="line-height:4em" >&nbsp;</div>
        <footer class="aui-bar aui-bar-tab aui-margin-b-15" id="footer" style="background-color:rgba(0,0,0,0);">
          <div class="aui-text-center" style="">
          <div id="btnSignIn" class="am-option-circle am-option-secondary aui-text-center "  style="line-height:3.5em;margin:auto;background-color:#eee"
           onclick="signInIn()">签到</div>
          </div>
      </footer>

    <script id="signInLocationTpl" type="text/html">
    {{each list}}
    <div class="aui-timeline-item">
        <div class="aui-timeline-item-label aui-bg-info text-light">{{$value[7] | formatSignKind}} </div>
        <div class="aui-timeline-item-inner">
            <div class="aui-card-list">
                <div class="aui-card-list-header aui-border-b">
                    <div>{{$value[2]}} <span class="aui-text-warning">{{$value[6]}}</span></div>
                </div>
                <div class="aui-card-list-content-padded">
                    <div class="aui-info" style="padding:0px">
                        <div class="aui-info-item aui-padded-r-10" style="width: 13rem">
                            <div>
                              <span  class="aui-ellipsis" style="display:inline" >备注:{{$value[3]}}</span>
                            </div>
                        </div>
                      </div>
                    <div class="aui-info" style="padding:0px;margin-top:5px">
                        <div class="aui-info-item aui-padded-r-10" >
                          <div>
                            <i class="aui-iconfont aui-icon-location"></i>
                            <span id="Address" class="aui-ellipsis" style="display:inline" onclick="showMsg($(this).html())">{{$value[4]}}</span>
                          </div>
                        </div>
                      </div>
                      <div class="aui-row aui-row-padded" style="margin-top:5px">
                        {{each $value[5]}}

                        <div class="aui-col-xs-4" style="height:6em" onclick="ImageApi.openImageBrowser(['{{$value[0]}}']);">
                            <img src="{{$value[0]}}" style="height:100%;width:100%"/>
                        </div>

                        {{/each}}
                      </div>
                </div>
            </div>
        </div>
    </div>
{{/each}}
    </script>
</body>
<script type='text/javascript' src='../script/api.js'></script>
<script type="text/javascript" src="../css/amazeui/js/jquery.min.js"></script>
<script type='text/javascript' src='../script/common.js'></script>
<script type='text/javascript' src='../script/queryapi.js'></script>
<script type='text/javascript' src='../script/template.js'></script>
<script type="text/javascript" src="../script/hammer.min.js"></script>
<script type="text/javascript" src="../script/imageapi.js"></script>
<script type="text/javascript" src="../script/aui-toast.js" ></script>
<script type='text/javascript'>

var signInStartTime="";
var currentDateStr = "";
var hadSignIn = false;
var hadSignOut = false;
var prNameMap={0:"上报位置",1:"签到",2:"签退",3:"外勤"};
template.helper('formatSignKind', function(pr) {
  return prNameMap[pr];
});

  apiready = function(){
    var height = $("#header").height();
    $('body').css('padding-top', height+1);

    initProjectLocations();
    AjaxApi.getdate(function(content){
       currentDateStr = content;
       $("#dateinfo").html(content);
       $("#dayinfo").html(getDay(content));

       loadProjSignInInfo(function(projStartTime,projEndTime,projSignDay){
            loadStatics(currentDateStr.substr(0,7),projStartTime,projEndTime,projSignDay);
       });

       if(currentDateStr && currentDateStr!=""){
         loadSigninPath(content);
       }
    });
  }

  function getTotalSignCnt(signMonth,projSignDay){
    var projSignDays = projSignDay.split(",");
    var signmonths = signMonth.split("-");
    var year = parseInt(signmonths[0]);
    var month = parseInt(signmonths[1]);
    var d = new Date(year,month,0);
    var maxdate =  d.getDate();
    var workday = 0;
    var currrentDate = Date.parse(currentDateStr);
    for(var i=1;i<=maxdate;++i){
        var tmpd = new Date(year,month-1,i);
        if(tmpd>currrentDate)
          continue;
        if($.inArray(tmpd.getDay()+"",projSignDays)>=0){
            ++workday;
        }
    }

    return workday;
  }

  function loadStatics(signMonth,projStartTime,projEndTime,projSignDay){
    var totalSignCnt = getTotalSignCnt(signMonth,projSignDay);

    var params = $.extend({"SignMonth":signMonth},TServerInfo.getProjUserParam());
    AjaxApi.query("query_1163",params,function(data){
      var lateCnt=0;var outCnt=0; var normalCnt=0;
      if(data.list){
        var datalist = data.list;
        for(var i=0;i<datalist.length;++i){
           var item = datalist[i];
           if(item[1] > projStartTime){
             ++lateCnt;
           }

           if(item[2] < projEndTime){
             ++outCnt;
           }

           if(item[1] <= projStartTime && item[2] >= projEndTime){
              ++normalCnt;
           }
        }

        $("#normalCnt").html(datalist.length);
        $("#lateCnt").html(lateCnt);
        $("#outCnt").html(outCnt);
        $("#noSignCnt").html(totalSignCnt-datalist.length);
      }else{
        $("#noSignCnt").html(totalSignCnt);
      }
    });
  }

  function showMsg(msg){
    api.toast({
        msg : msg,
        duration : 1000,
        location : 'bottom'
      });
  }

  function getDay(datestr){
    var serverDate = new Date(Date.parse(datestr));
    var myddy=serverDate.getDay();//获取存储当前日期
    var weekday=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"];
    return weekday[myddy];
  }

  function loadProjSignInInfo(callback){
    AjaxApi.rest("retrievEntity","Project",TServerInfo.getProjectId(),function(data){
        var projectObj = data;
        signInStartTime = projectObj.SignInStartTime;
        $("#SignInStartTime").html(projectObj.SignInStartTime);
        $("#SignInEndTime").html(projectObj.SignInEndTime);

        callback(projectObj.SignInStartTime,projectObj.SignInEndTime,projectObj.SignInDays);
    });
  }

  function loadData(){
    if(currentDateStr && currentDateStr!=""){
      loadSigninPath(currentDateStr);
    }
  }

  function loadSigninPath(signTime){
    var params = $.extend({"SignTime":signTime},TServerInfo.getProjUserParam());
    AjaxApi.query("query_1162",params,function(data){
      if(data.list){
        var datalist = data.list;
        preLateProc(datalist);
        preFeedbackImageUrl(datalist);
        var tplData = {
          "list" : datalist
        };
        var html = template("signInLocationTpl", tplData);
        $("#signInLocationContent").html(html);

      }

      if(hadSignIn){
          $("#btnSignIn").html("签退");
      }

      if(hadSignOut){
        $("#btnSignIn").css("display","none");
      }
    });
  }

  function compareLate(idx,item){
    if(item[2] > signInStartTime){
       item[6] ="迟到";
    }else{
      item[6] ="";
    }
  }

  function preLateProc(datalist){
      for(var i=0;i<datalist.length;++i){
        var item = datalist[i];
        var kind = item[7];
        if(kind == 1 || kind ==3){
          hadSignIn = true;
          compareLate(i,item);
        }else{
          item[6] ="";
        }

        if(kind == 2){
          hadSignOut=true;
        }
      }
  }

  function preFeedbackImageUrl(datalist){
    var picIndex = 5;
      for (var i = 0; i < datalist.length; i++) {
        var item = datalist[i];
        if(item[picIndex] && item[picIndex]!=""){
          var picIds = item[picIndex].split(",");
          var picUrls = [];
          for(var j=0;j<picIds.length;++j){
            var url= ImageApi.getImageUrl(item[0],picIds[j]);
            picUrls.push([url]);
          }
          item[picIndex] =picUrls;
        }else{
          item[picIndex] =[];
        }
      }
  }

  function signIn(){
    api.openWin({
                  name: "signinpathcurd_win",
                  url: "signinpathcurd_win.html",
                  pageParam: {
                      isFrame: false
                  },
                  bgColor: '#FFFFFF',
                  slidBackEnabled: false,
                  vScrollBarEnabled:false,
                  hScrollBarEnabled:false,
                  delay: 0
              }
      );
  }

  var projectLocations=[];
  var isInitedPl = false;
  function initProjectLocations(){
    AjaxApi.query("query_1161",{"ProjectId":TServerInfo.getProjectId()},function(data){
      if(data.list){
        projectLocations = data.list;
      }
      isInitedPl = true;
    });
  }

  function searchProjLocationId(loclon,loclat){
      for(var i=0;i<projectLocations.length;++i){
         var item = projectLocations[i];
         var lon = parseFloat(item[3]);
         var lat = parseFloat(item[4]);
         var range = parseFloat(item[5]);

         var distance = calcDistance(lon,lat,loclon,loclat);
         if(distance<=range){
              return [item[0],distance];
         }
      }

      return ["",0];
  }

  function signInIn(){
    if(!isInitedPl)
        return ;

    doSignIn();
  }

function doSignIn(){
  execAMapLBS(function(aMapLBS){
    aMapLBS.singleLocation({
        timeout: 10
    }, function(ret, err) {
        if (ret.status && ret.lon!=0 && ret.lat!=0) {
            var lon = ret.lon;
            var lat = ret.lat;

            var result = searchProjLocationId(lon,lat);
            var signInLocationId = result[0];
            var signInOffset = result[1];

            aMapLBS.singleAddress({
              timeout: 10
            }, function(ret2, err) {
                  if (ret2.status) {
                      var address = ret2.address.formattedAddress;
                      signInSaveData(lon,lat,address,signInLocationId,signInOffset);
                  }else{
                    api.toast({
                      msg : '定位失败',
                      duration : 2000,
                      location : 'bottom'
                    });
                  }
              });
        }else {
          api.toast({
            msg : '定位失败',
            duration : 2000,
            location : 'bottom'
          });
        }
    });
  });
}

function signInSaveData(lon,lat,address,signInLocationId,signInOffset){
  if(signInLocationId ==""){
    api.confirm({
        title: '提示',
        msg: '距离项目考勤点太远，是否外勤',
        buttons: ['确定', '取消']
      }, function(ret, err) {
        var index = ret.buttonIndex;
        if(index == 1){
            createEnity(lon,lat,address,signInLocationId,signInOffset,3);
        }
      });
  }else{
    createEnity(lon,lat,address,signInLocationId,signInOffset,hadSignIn?2: 1);
  }
}

function createEnity(lon,lat,address,signInLocationId,signInOffset,kind){
  var ownerId = GetUuid();
  var entObj = {"Id":ownerId,
        "Kind":kind,
        "SignInLocationId":signInLocationId,
        "Lon":lon,
        "Lat":lat,
        "Offset":signInOffset,
        "Address":address,
        "Remark":"",
        "ProjectId":TServerInfo.getProjectId(),
        "UserId":TServerInfo.getUserId()
      };

  AjaxApi.rest("createEntity","OaSignInPath",entObj,function(data){
    api.toast({
      msg : '打卡成功',
      duration : 2000,
      location : 'bottom'
    });
    loadData();
  },{"noTips":true});
}

</script>

</html>
