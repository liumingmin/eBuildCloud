<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/font-awesome/css/font-awesome.min.css" />
    <style type="text/css">
    .aui-list .aui-list-item-media {
        width: 3rem;
    }
    .notes-add {
        position: fixed;
        left: 0.5rem;
        bottom: 0.5rem;
        width: 3rem;
        z-index: 99;
    }
    textarea {
        height: 8rem;
        background-color: #ffffff;
        padding: 0.5rem;
    }
    .photos img {
        display: block;
        width: 100%;
    }
    .add-photos > div {
        width: 100%;
        height:5.15rem;
        line-height: 5.15rem;
    }
    .add-photos > div .aui-iconfont {
        font-size: 2rem;
        color: #ccc;
    }
    .image-item {
        position: relative;
        height: 5.3rem;
        overflow: hidden;
        background-color: #f0f0f0;
    }
    .image-item img {
        display: block;
        margin: 0 auto;
        width: auto;
        height: 100%;
    }
    .image-item .delete-btn {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 28px;
        height: 28px;
        background-color: rgba(0,0,0,0.7);
        margin-left: -14px;
        margin-top: -14px;
        color: #ffffff;
        text-align: center;
        border-radius: 50%;
    }
    </style>
</head>
<body>
  <section class="aui-content-padded">
    <textarea id="Remark" placeholder="备注" style="height:4em;overflow-y:scroll;"></textarea>
  </section>
  <p class="aui-margin-l-15 aui-margin-t-15">附件图片(长按可删除图片) </p>
  <section class="aui-content-padded">
    <div id="imageLists"  class="aui-row aui-row-padded">
        <div id="txtImage" class="aui-col-xs-4 add-photos" onclick="ImageApi.fastSelectImage({},'txtImage',true);">
            <div class="aui-border aui-text-center">
                <i class="aui-iconfont aui-icon-plus"></i>
            </div>
        </div>
    </div>
  </section>
  <section class="aui-content-padded">

    <div class="aui-info">
        <div class="aui-info-item aui-padded-r-10" style="width: 13rem">
            <div>
                <i class="aui-iconfont aui-icon-location"></i>
                <span id="Address" class="aui-ellipsis" style="display:inline"  onclick="showMsg($(this).html())"></span>
            </div>
        </div>

        <div class=" aui-info-item aui-text-right" style="width: 50px;" tapmode onclick="getLocation()">
            <i id="Locicon" class="fa fa-refresh    aui-text-info aui-margin-r-5"></i>
            <span class="aui-text-info  ">定位</span>
        </div>
    </div>
  </section>

</body>

<script type='text/javascript' src='../script/api.js'></script>
<script type="text/javascript" src="../css/amazeui/js/jquery.min.js"></script>
<script type='text/javascript' src='../script/common.js'></script>
<script type='text/javascript' src='../script/queryapi.js'></script>
<script type='text/javascript' src='../script/template.js'></script>
<script type="text/javascript" src="../script/hammer.min.js"></script>
<script type="text/javascript" src="../script/imageapi.js"></script>
<script type="text/javascript" src="../script/aui-toast.js" ></script>
<script type="text/javascript" src="../script/bluebird.min.js" ></script>

<script type='text/javascript'>
var toast = new auiToast();
var signInLocationId="";
var signInLon=0;
var signInLat=0;
var signInOffset=0;
apiready = function(){
  //initProjectLocations();
}

function showMsg(msg){
  api.toast({
      msg : msg,
      duration : 1000,
      location : 'bottom'
    });
}

function enableClickOnceBtn(){
  try{
  api.execScript({
    name: 'signinpathcurd_win',
    script: 'enableClickOnceBtn()'
   });
  }catch(e){}
}

function commit()
{
  if($("#Remark").val() == ""){
    showMsg("备注必填!");
    enableClickOnceBtn();
    return ;
  }

  // if(!signInLocationId || signInLocationId==""){
  //   showMsg("必须定位位置!");
  //   return ;
  // }


  toast.loading({
        title:"正在保存...",
        duration:2000
    },function(ret){

    });

    saveSignInPath();
}

var masterEntityOp = new EntityBatchOp("OaSignInPath","");

function saveSignInPath(){
  var ownerId = GetUuid();
  var entObj = {"Id":ownerId,
        "SignInLocationId":signInLocationId,
        "Lon":signInLon,
        "Lat":signInLat,
        "Offset":signInOffset,
        "Address":$("#Address").html(),
        "Remark":$("#Remark").val(),
        "ProjectId":TServerInfo.getProjectId(),
        "UserId":TServerInfo.getUserId()
      };
  masterEntityOp.addEntity(entObj);

  //images
  var imageInfos = [];
  $("#imageLists").find("img").each(function(){
    var imageInfo = ImageApi.getImageInfo($(this).attr("id"),$(this).attr("src"),"");
    imageInfo["OwnerId"] = ownerId;
    imageInfos.push(imageInfo);
  });

  AjaxApi.batchSave([masterEntityOp],imageInfos,
    {"noTips":true},function(data){
       saveSuccess();
  });
}

// function saveImages(ownerId){
//   return new Promise(function(resolve, reject) {
//     var imageInfos = [];
//     $("#imageLists").find("img").each(function(){
//       var imageInfo = ImageApi.getImageInfo($(this).attr("id"),$(this).attr("src"),"");
//       imageInfos.push(imageInfo);
//     });
//
//     if(imageInfos.length>0){
//         AjaxApi.fastUploadImages(imageInfos,ownerId,function(ret){
//             resolve(ownerId);
//         });
//     }else{
//        resolve(ownerId);
//     }
//   });
// }

function reloadParent(){
  try{
  api.execScript({
    name: 'signinpath_win',
    frameName: 'signinpath_frm',
    script: 'loadData()'
   });
 }catch(e){}
}

function saveSuccess(){
  api.toast({
      msg : "提交成功!",
      duration : 1000,
      location : 'bottom'
    });

setTimeout(function(){reloadParent();api.closeWin();},1000);
}

// var projectLocations=[];
// function initProjectLocations(){
//   AjaxApi.query("query_1161",{"ProjectId":TServerInfo.getProjectId()},function(data){
//     if(data.list){
//       projectLocations = data.list;
//     }
//   });
// }
//
// function searchProjLocationId(loclon,loclat){
//     for(var i=0;i<projectLocations.length;++i){
//        var item = projectLocations[i];
//        var lon = parseFloat(item[3]);
//        var lat = parseFloat(item[4]);
//        var range = parseFloat(item[5]);
//
//        var distance = calcDistance(lon,lat,loclon,loclat);
//        if(distance<=range){
//             return [item[0],distance];
//        }
//     }
//
//     return ["",0];
// }

var islocating = false;
function getLocation(mode){
  if(islocating)
     return;

  islocating = true;
  $("#"+"Locicon").addClass("fa-spin");

 execAMapLBS(function(aMapLBS){
   aMapLBS.singleLocation({
       timeout: 10
   }, function(ret, err) {
       if (ret.status && ret.lon!=0 && ret.lat!=0) {
           var lon = ret.lon;
           var lat = ret.lat;

          //  var result = searchProjLocationId(lon,lat);
          //  if(result[0] ==""){
          //    islocating = false;
          //    $("#"+"Locicon").removeClass("fa-spin");
           //
          //    api.toast({
          //      msg : "距离项目考勤点太远，无法打卡",
          //      duration : 2000,
          //      location : 'bottom'
          //    });
          //    return ;
          //  }else{
             signInLocationId = "";
             signInLon = lon;
             signInLat = lat;
             signInOffset = 0;
           //}

           aMapLBS.singleAddress({
             timeout: 10
           }, function(ret2, err) {
                 islocating = false;
                 $("#"+"Locicon").removeClass("fa-spin");

                 if (ret2.status) {
                     $("#"+"Address").html(ret2.address.formattedAddress);
                 }else{
                   api.toast({
                     msg : '定位失败',
                     duration : 2000,
                     location : 'bottom'
                   });
                 }
             });
       }else {
         islocating = false;
         $("#"+"Locicon").removeClass("fa-spin");

         api.toast({
           msg : '定位失败',
           duration : 2000,
           location : 'bottom'
         });
       }
   });
 });

}

</script>
</html>
