<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui-pull-refresh.css" />
    <link rel="stylesheet" type="text/css" href="../../css/plaintcalendar/calendar.css" />
    <style type="text/css">
    .am-with-fixed-tab {
      padding-top: 2rem;
    }

    .able2 {
			background: rgba(255, 0, 255, .8);
		}

    .am-option-circle{
    	border-radius: 50%;
    	width:4em;
    	height: 4em;
    	padding-top: .25em;
    }

    .am-option-secondary {
        border-color: #3bb4f2;
        border: 1px solid ;
        color:#3bb4f2;
    }

    .datehint{
      text-align: center;
      color: rgb(0, 128, 255);
    }
    </style>
</head>
<body class="am-with-fixed-tab">
  <div id="header" class="am-header-fixed">
    <div class="aui-tab " id="tab" >
        <div class="aui-tab-item aui-active">我的记工</div>
        <div class="aui-tab-item ">项目记工</div>
        <div class="aui-tab-item">人工结算</div>
    </div>
  </div>

    <section class="aui-refresh-content">
        <div id="myWorkercostContent" name="workercostTabContent" class="aui-list aui-media-list" style="background-color:#f5f5f5">
          <div>
            <div id="myCalendarContainer"></div>
          </div>


        </div>

        <ul id="projectWorkercostContent" name="workercostTabContent" class="aui-list aui-media-list" style="background-color:#f5f5f5;display:none">
          <div>
            <div id="projectCalendarContainer"></div>
          </div>
        </ul>

        <div id="workerPayTab" name="workercostTabContent" style="display:none">
          <div class="aui-searchbar aui-padded-l-15 aui-padded-r-15" id="search">
            <div class="aui-searchbar-input aui-border-radius" tapmode>
                <i class="aui-iconfont aui-icon-search"></i>
                <form action="javascript:search();">
                    <input type="search" placeholder="请输入搜索内容" id="search-input">
                </form>
            </div>
            <div class="aui-searchbar-cancel" tapmod onclick="search()">搜索</div> &nbsp;
            <div class="aui-searchbar-cancel" tapmod onclick="cancelSearch()">取消</div>

          </div>

          <ul id="workerPayContent"  class="aui-list aui-media-list" style="background-color:#f5f5f5;">

          </ul>
        </div>
      </section>


    <script id="workerPayTpl" type="text/html">

        {{each list}}

        <li class="aui-list-item aui-list-item-middle" style="background-color:#ffffff;" onclick="payWorker('{{$value[0]}}','{{$value[1]}}')">
          <div class="aui-row aui-list-item-text aui-font-size-12 aui-padded-t-5 aui-padded-b-10 aui-padded-r-15" >
            <div class="aui-col-xs-6 aui-text-left aui-font-size-14">{{$value[1]}}({{$value[2]}})</div>
            <div class="aui-col-xs-6 aui-text-right">{{$value[3]}}</div>
          </div>

          <div class="aui-row aui-list-item-text aui-font-size-12 aui-padded-t-5 aui-padded-b-10 aui-padded-r-15" >
            <div class="aui-col-xs-6 aui-text-left">已结:{{$value[4]}} </div>
            <div class="aui-col-xs-6 aui-text-right">未结:{{$value[5]}}</div>
          </div>
        </li>

        {{/each}}
    </script>

    <footer class="aui-bar aui-bar-tab aui-margin-b-15" id="footer" style="background-color:rgba(0,0,0,0);">
      <!-- <div id="datehint" class="datehint" style="line-height:2em" >&nbsp;</div> -->
      <div  class="am-option-circle am-option-secondary aui-text-center "  style="line-height:3.5em;margin:auto;background-color:#eee"
       onclick="toCreateNowBonus()">记工
     </div>
    </footer>

    <!-- {{if $value[6] ==0}}{{/if}} -->
</body>
<script type="text/javascript" src="../../css/amazeui/js/jquery.min.js"></script>
<script type="text/javascript" src="../../css/plaintcalendar/calendar.js"></script>
<script type="text/javascript" src="../../script/api.js" ></script>
<script type='text/javascript' src='../../script/common.js'></script>
<script type='text/javascript' src='../../script/queryapi.js'></script>
<script type='text/javascript' src='../../script/template.js'></script>
<script type="text/javascript" src="../../script/aui-pull-refresh.js"></script>
<script type="text/javascript" src="../../script/aui-scroll.js" ></script>
<script type='text/javascript' src='../../script/controls.js'></script>
<script type="text/javascript" src="../../script/aui-tab.js"></script>

<script type="text/javascript">

var tab;
var tabIndex = 1;
var tab2loaded = false;
var tab3loaded = false;

var nowDate = new Date();
nowDate.TrimDate();

var mySwitchDate= new Date();
var projectSwitchDate= new Date();

// var nextMonth =new Date();
// nextMonth.NextMonth();
// nextMonth.setDate(1);

var myCalendar;
var projectCalendar;

var pageCompWorkerPay = new PageComponent(0,10,loadWorkerPays);
var workerPaySearchText = "";

apiready = function () {

  var height = $("#header").height();
  $('body').css('padding-top', height+1);

  createTab();
  initPull();
  initPullBottom();

  AjaxApi.getdate(function(datestr){
    nowDate = new Date(Date.parse(datestr));
    nowDate.TrimDate();

    mySwitchDate = new Date(Date.parse(datestr));
    projectSwitchDate = new Date(Date.parse(datestr));

    //$("#datehint").text(nowDate.getFullYear()+"-"+(nowDate.getMonth()+1)+"-"+nowDate.getDate());
    loadMyCalendar();
  });

}

function loadMyCalendar(){

  myCalendar = new Calendar({
		// 用户传入实际的数据
		container: 'myCalendarContainer',
		angle: 14,
		isMask: false, // 是否需要弹层
		beginTime: [nowDate.getFullYear()-5, 1, 1],//如空数组默认设置成1970年1月1日开始,数组的每一位分别是年月日。
		endTime: [nowDate.getFullYear(), nowDate.getMonth()+1, nowDate.getDate()],//如空数组默认设置成次年12月31日,数组的每一位分别是年月日。
		recentTime: [nowDate.getFullYear(), nowDate.getMonth()+1, nowDate.getDate()],//如空数组默认设置成当月1日,数组的每一位分别是年月日。
		isSundayFirst: false, // 周日是否要放在第一列
		isShowNeighbor: true, // 是否展示相邻月份的月尾和月头
		isToggleBtn: true, // 是否展示左右切换按钮
		isChinese: true, // 是否是中文
		monthType: 0, // 0:1月, 1:一月, 2:Jan, 3: April
		canViewDisabled: true, // 是否可以阅读不在范围内的月份
		beforeRenderArr: [{
			stamp: nowDate.getTime(),
			className: 'able2',
		}],
		success: function (item, arr) {
      toCreateMyBonus(item);
		},
		switchRender: function (year, month, cal) {
     mySwitchDate.setFullYear(year);
     mySwitchDate.setMonth(month);
     mySwitchDate.setDate(1);
     loadMyWorkerBonus(mySwitchDate);
   },
   bonusAddVisible:true,
   bonus:{}
	});

  loadMyWorkerBonus(mySwitchDate);
}

function loadMyWorkerBonus(parmDate){
  var selDate = new Date(parmDate);
  selDate.TrimDate();
  selDate.setDate(1);
  var startDate = selDate.getTime()/1000;

  selDate.NextMonth();
  selDate.setDate(1);

  var endDate = selDate.getTime()/1000;

  var param = $.extend({"StartDate":startDate+"","EndDate":endDate+""},TServerInfo.getProjUserParam());
  AjaxApi.query("query_2005",param,function(data){
    var datalist = data.list;
    if(datalist){
      var bonusObj={};
      for(var i=0;i<datalist.length;i++){
        var item = datalist[i];
        bonusObj[parseInt(item[0]*1000)]=parseFloat(item[1]);
      }
      myCalendar.setBonus(bonusObj);
    }
  });
}

//create callback
function loadData(){
   loadMyWorkerBonus(mySwitchDate);
   loadProjectWorkerBonus(projectSwitchDate);
}

function toCreateMyBonus(timestamp){
  api.openWin({
                name: "workerbonuscurd_win",
                url: "workerbonuscurd_win.html",
                pageParam: {
                    isFrame: false,
                    timestamp:timestamp
                },
                bgColor: '#FFFFFF',
                slidBackEnabled: false,
                vScrollBarEnabled:false,
                hScrollBarEnabled:false,
                delay: 0
            }
    );
}

function toCreateNowBonus(){
  api.openWin({
                name: "workerbonuscurd_win",
                url: "workerbonuscurd_win.html",
                pageParam: {
                    isFrame: false,
                    timestamp:nowDate.getTime()
                },
                bgColor: '#FFFFFF',
                slidBackEnabled: false,
                vScrollBarEnabled:false,
                hScrollBarEnabled:false,
                delay: 0
            }
    );
}


function loadProjectCalendar(){
  projectCalendar = new Calendar({
		// 用户传入实际的数据
		container: 'projectCalendarContainer',
		angle: 14,
		isMask: false, // 是否需要弹层
		beginTime: [nowDate.getFullYear()-5, 1, 1],//如空数组默认设置成1970年1月1日开始,数组的每一位分别是年月日。
		endTime: [nowDate.getFullYear()+5, 12, 31],//如空数组默认设置成次年12月31日,数组的每一位分别是年月日。
		recentTime: [nowDate.getFullYear(), nowDate.getMonth()+1, nowDate.getDate()],//如空数组默认设置成当月1日,数组的每一位分别是年月日。
		isSundayFirst: false, // 周日是否要放在第一列
		isShowNeighbor: true, // 是否展示相邻月份的月尾和月头
		isToggleBtn: true, // 是否展示左右切换按钮
		isChinese: true, // 是否是中文
		monthType: 0, // 0:1月, 1:一月, 2:Jan, 3: April
		canViewDisabled: true, // 是否可以阅读不在范围内的月份
		beforeRenderArr: [{
			stamp: nowDate.getTime(),
			className: 'able2',
		}],
		success: function (item, arr) {

		},
		switchRender: function (year, month, cal) {
     projectSwitchDate.setFullYear(year);
     projectSwitchDate.setMonth(month);
     projectSwitchDate.setDate(1);
     loadProjectWorkerBonus(projectSwitchDate);
   },
   bonusAddVisible:false,
   bonus:{}
	});

  loadProjectWorkerBonus(projectSwitchDate);
}

function loadProjectWorkerBonus(parmDate){
  var selDate = new Date(parmDate);
  selDate.TrimDate();
  selDate.setDate(1);
  var startDate = selDate.getTime()/1000;

  selDate.NextMonth();
  selDate.setDate(1);

  var endDate = selDate.getTime()/1000;

  var param = {"StartDate":startDate+"","EndDate":endDate+"","ProjectId":TServerInfo.getProjectId()};
  AjaxApi.query("query_2006",param,function(data){
    var datalist = data.list;
    if(datalist){
      var bonusObj={};
      for(var i=0;i<datalist.length;i++){
        var item = datalist[i];
        bonusObj[parseInt(item[0]*1000)]=parseFloat(item[1]);
      }
      try{
        projectCalendar.setBonus(bonusObj);
      }catch(e){}
    }
  });
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function initPull(){
  var pullRefresh = new auiPullToRefresh({
    container: document.querySelector('.aui-refresh-content'),
    triggerDistance: 100
},function(ret){
    if(ret.status=="success"){
      pageCompWorkerPay.load();
      setTimeout(function(){
        pullRefresh.cancelLoading(); //刷新成功后调用此方法隐藏
      },1500);
    }
})
}

function createTab(){
  tab = new auiTab({
   element:document.getElementById("tab"),
},function(ret){
  switchTab(ret["index"]);
});
}

function switchTab(idx){
  tabIndex = idx;
  if(tabIndex == 1){
    hideTabContents();
  $("#myWorkercostContent").css("display","block");
  $("#footer").css("display","block");
  }else if(tabIndex==2){
    hideTabContents();
    $("#projectWorkercostContent").css("display","block");
    if(!tab2loaded){
      tab2loaded = true;
      loadProjectCalendar();
    }
  }else if(tabIndex==3){
    if(!tab3loaded) pageCompWorkerPay.load();
    tab3loaded=true;
    hideTabContents();
    $("#workerPayTab").css("display","block");
  }
}

function hideTabContents(){
  $("*[name='workercostTabContent']").each(function(){
    $(this).css("display","none");
  });
  $("#footer").css("display","none");
}

function initPullBottom(){
  var scroll = new auiScroll({
          listen:true,
          distance:5 //判断到达底部的距离，isToBottom为true
      },function(ret){
          if(ret.isToBottom){
            pageCompWorkerPay.loadMore();
            //alert("已到达底部");
              //document.getElementById("demo").textContent = "已到达底部";
          }else{
              //document.getElementById("demo").textContent = "滚动高度："+ret.scrollTop;

          }

      });

}

function loadWorkerPays(pagecomp){
  selDate = new Date(nowDate);
  selDate.TrimDate();
  selDate.setDate(1);
  var startDate = selDate.getTime()/1000;

  selDate.NextMonth();
  selDate.setDate(1);

  var endDate = selDate.getTime()/1000;

  pagecomp.setLoadState(true);
  var param = $.extend({"StartDate":startDate+"","EndDate":endDate+""},pagecomp.getPageParam(),TServerInfo.getProjUserParam());

  if(workerPaySearchText!=""){
     param["WorkerName"] = workerPaySearchText;
  }

  AjaxApi.query("query_2011",param,function(data){
    if(data.total) pagecomp.setTotal(data.total);

    var datalist = data.list;
    if(datalist){
      var tplData = {
        "list" : datalist
      };
      var html = template("workerPayTpl", tplData);

      if(pagecomp.getIsAppend()){
        $("#workerPayContent").append(html);
      }else{
        if(datalist.length > 0){
          $("#workerPayContent").html(html);
        }else{
          $("#workerPayContent").html(gWhitespaceHtml);
        }
      }
    }else{
      $("#workerPayContent").html(gWhitespaceHtml);
    }
    pagecomp.setLoadState(false);
  });
}

function reloadWorkPay(){
  pageCompWorkerPay.load();
}

function search(){
  workerPaySearchText = $("#search-input").val();
  pageCompWorkerPay.load();
}

function cancelSearch(){
  $("#search-input").val("");
  workerPaySearchText = "";
  pageCompWorkerPay.load();
}

function payWorker(id,name){

  api.openWin({
                name: "workerpaylist_win",
                url: "workerpaylist_win.html",
                pageParam: {
                    isFrame: false,
                    workerId:id,
                    workerName:name
                },
                bgColor: '#FFFFFF',
                slidBackEnabled: false,
                vScrollBarEnabled:false,
                hScrollBarEnabled:false,
                delay: 0
            }
    );
}

</script>
</html>
